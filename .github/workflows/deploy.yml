<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MyDentalClinic</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007aff">
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
      background:#f5f5f7; 
      margin:0; 
      padding:16px;
    }
    h1 { text-align:center; margin-bottom:24px; color:#333; }
    
    /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
    .nav { 
      display: flex; 
      gap:8px; 
      margin-bottom:20px; 
      flex-wrap: wrap;
    }
    .nav button {
      flex:1;
      min-width:120px;
      padding:12px;
      border:none;
      border-radius:10px;
      background:#e5e5ea;
      color:#333;
      font-size:14px;
      cursor:pointer;
      transition: all 0.3s;
    }
    .nav button.active {
      background:#007aff;
      color:white;
    }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
    .card { 
      background:#fff; 
      border-radius:16px; 
      padding:20px; 
      margin-bottom:16px; 
      box-shadow:0 4px 10px rgba(0,0,0,0.08);
    }
    
    /* –§–æ—Ä–º—ã */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap:12px;
      margin-bottom:16px;
    }
    input, select { 
      width:100%; 
      padding:12px; 
      margin:4px 0; 
      border-radius:10px; 
      border:1px solid #ccc; 
      font-size:14px;
    }
    button { 
      padding:12px 24px; 
      border:none; 
      border-radius:12px; 
      background:#007aff; 
      color:#fff; 
      font-size:16px; 
      cursor:pointer;
      transition: background 0.3s;
    }
    button:hover {
      background:#0056cc;
    }
    button.secondary {
      background:#e5e5ea;
      color:#333;
    }
    button.danger {
      background:#ff3b30;
      color:white;
    }
    
    /* –ü–∞—Ü–∏–µ–Ω—Ç—ã */
    .patient { 
      border-bottom:1px solid #eee; 
      padding:12px 0; 
      display:flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .patient-info { flex:1; }
    .patient-actions { display:flex; gap:8px; }
    .patient-name { 
      font-weight:600; 
      font-size:16px; 
      margin-bottom:4px;
      color:#333;
    }
    .patient-meta { 
      font-size:14px; 
      color:#666; 
      margin-bottom:4px;
    }
    .patient-payment {
      font-weight:500;
      margin-top:8px;
      padding:6px 12px;
      background:#f8f8fa;
      border-radius:8px;
      display:inline-block;
    }
    .paid { color:#34c759; }
    .debt { color:#ff9500; }
    
    /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
    .calendar-header {
      display:flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom:16px;
    }
    .calendar-nav {
      display:flex;
      gap:12px;
      align-items: center;
    }
    .calendar-grid {
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:4px;
      margin-bottom:16px;
    }
    .calendar-day {
      aspect-ratio: 1;
      display:flex;
      align-items: center;
      justify-content: center;
      border-radius:10px;
      cursor:pointer;
      font-size:14px;
      position:relative;
    }
    .calendar-day:hover {
      background:#f0f0f5;
    }
    .calendar-day.today {
      background:#007aff;
      color:white;
    }
    .calendar-day.has-appointments::after {
      content:"";
      position:absolute;
      bottom:4px;
      width:6px;
      height:6px;
      background:#ff3b30;
      border-radius:50%;
    }
    .calendar-day.selected {
      background:#007aff20;
      border:2px solid #007aff;
    }
    
    /* –í—Ä–∞—á–∏ */
    .doctor-tag {
      display:inline-block;
      padding:4px 12px;
      background:#34c75920;
      color:#34c759;
      border-radius:12px;
      font-size:12px;
      margin:2px;
    }
    
    /* –°–µ–∫—Ü–∏–∏ */
    .section {
      display:none;
      animation: fadeIn 0.3s;
    }
    .section.active {
      display:block;
    }
    
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    .modal {
      display:none;
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.5);
      z-index:1000;
      align-items:center;
      justify-content:center;
    }
    .modal-content {
      background:white;
      border-radius:20px;
      padding:24px;
      width:90%;
      max-width:500px;
      max-height:80vh;
      overflow-y:auto;
    }
    .modal-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
    }
    
    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
    .stats-grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap:12px;
      margin-top:16px;
    }
    .stat-card {
      background:#f8f8fa;
      padding:16px;
      border-radius:12px;
      text-align:center;
    }
    .stat-value {
      font-size:24px;
      font-weight:600;
      margin:8px 0;
    }
    
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(10px); }
      to { opacity:1; transform:translateY(0); }
    }
  </style>
</head>
<body>
<h1>ü¶∑ MyDentalClinic</h1>

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
<div class="nav">
  <button data-section="calendar" onclick="showSection('calendar', event)" class="active">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
  <button data-section="patients" onclick="showSection('patients', event)">üë• –ü–∞—Ü–∏–µ–Ω—Ç—ã</button>
  <button data-section="doctors" onclick="showSection('doctors', event)">üë®‚Äç‚öïÔ∏è –í—Ä–∞—á–∏</button>
  <button data-section="finance" onclick="showSection('finance', event)">üí∞ –§–∏–Ω–∞–Ω—Å—ã</button>
  <button data-section="add" onclick="showSection('add', event)">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
</div>

<!-- –°–µ–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ -->
<div id="add" class="section active">
  <div class="card">
    <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å</h3>
    <div class="form-grid">
      <input id="fio" placeholder="–§–ò–û –ø–∞—Ü–∏–µ–Ω—Ç–∞">
      <input id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
      <input id="procedure" placeholder="–ü—Ä–æ—Ü–µ–¥—É—Ä–∞">
      <select id="doctor">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞</option>
      </select>
      <input type="date" id="date">
      <input type="time" id="time">
      <input id="duration" placeholder="–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)" type="number">
      <input id="price" placeholder="–ö –æ–ø–ª–∞—Ç–µ (—Å—É–º)" type="number">
      <input id="paid" placeholder="–û–ø–ª–∞—á–µ–Ω–æ (—Å—É–º)" type="number" value="0">
      <input id="notes" placeholder="–ó–∞–º–µ—Ç–∫–∏">
    </div>
    <button onclick="addPatient()">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
  </div>
</div>

<!-- –°–µ–∫—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
<div id="calendar" class="section">
  <div class="card">
    <div class="calendar-header">
      <h3 id="current-month">–Ø–Ω–≤–∞—Ä—å 2024</h3>
      <div class="calendar-nav">
        <button onclick="prevMonth()" class="secondary">‚Üê</button>
        <button onclick="todayMonth()">–°–µ–≥–æ–¥–Ω—è</button>
        <button onclick="nextMonth()" class="secondary">‚Üí</button>
      </div>
    </div>
    <div class="calendar-grid" id="calendar-grid"></div>
    <div id="day-appointments"></div>
  </div>
</div>

<!-- –°–µ–∫—Ü–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ -->
<div id="patients" class="section">
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h3>–ü–∞—Ü–∏–µ–Ω—Ç—ã</h3>
      <input type="text" id="search-patient" placeholder="–ü–æ–∏—Å–∫ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤..." style="width:200px;">
    </div>
    <div id="patient-list"></div>
  </div>
</div>

<!-- –°–µ–∫—Ü–∏—è –≤—Ä–∞—á–µ–π -->
<div id="doctors" class="section">
  <div class="card">
    <h3>–í—Ä–∞—á–∏</h3>
    <div class="form-grid">
      <input id="doctor-name" placeholder="–ò–º—è –≤—Ä–∞—á–∞">
      <input id="doctor-specialty" placeholder="–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è">
      <input id="doctor-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
    </div>
    <button onclick="addDoctor()">–î–æ–±–∞–≤–∏—Ç—å –≤—Ä–∞—á–∞</button>
    <div id="doctor-list" style="margin-top:20px;"></div>
  </div>
</div>

<!-- –°–µ–∫—Ü–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤ -->
<div id="finance" class="section">
  <div class="card">
    <h3>–§–∏–Ω–∞–Ω—Å—ã</h3>
    <div class="stats-grid">
      <div class="stat-card">
        <div>–í—Å–µ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</div>
        <div class="stat-value" id="total-price">0</div>
      </div>
      <div class="stat-card">
        <div>–ü–æ–ª—É—á–µ–Ω–æ</div>
        <div class="stat-value" id="total-paid">0</div>
      </div>
      <div class="stat-card">
        <div>–î–æ–ª–≥</div>
        <div class="stat-value" id="total-debt">0</div>
      </div>
      <div class="stat-card">
        <div>–ó–∞ –º–µ—Å—è—Ü</div>
        <div class="stat-value" id="month-income">0</div>
      </div>
    </div>
    <h4 style="margin-top:24px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏</h4>
    <div id="payment-history"></div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞ -->
<div id="patient-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞</h3>
      <button onclick="closeModal()" style="background:none; border:none; font-size:24px; cursor:pointer;">√ó</button>
    </div>
    <div id="modal-patient-content"></div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–Ω—è -->
<div id="day-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modal-day-title"></h3>
      <button onclick="closeDayModal()" style="background:none; border:none; font-size:24px; cursor:pointer;">√ó</button>
    </div>
    <div id="modal-day-content"></div>
  </div>
</div>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
let patients = JSON.parse(localStorage.getItem('patients') || '[]');
let doctors = JSON.parse(localStorage.getItem('doctors') || '[]');
let currentSection = 'add';
let currentDate = new Date();
let selectedDate = null;
let selectedPatient = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ä–∞—á–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
if (doctors.length === 0) {
  doctors = [
    { id: 1, name: '–ò–≤–∞–Ω–æ–≤ –ê.–ê.', specialty: '–•–∏—Ä—É—Ä–≥', phone: '+998901234567' },
    { id: 2, name: '–ü–µ—Ç—Ä–æ–≤–∞ –ú.–ò.', specialty: '–¢–µ—Ä–∞–ø–µ–≤—Ç', phone: '+998907654321' }
  ];
  localStorage.setItem('doctors', JSON.stringify(doctors));
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
function init() {
  renderDoctorsSelect();
  renderPatients();
  renderDoctors();
  updateCalendar();
  updateFinance();
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–±–µ–∑ reliance –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã–π event)
  showSection('add');
}

// –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å–µ–∫—Ü–∏—è–º
function showSection(sectionId, evt) {
  // –£–¥–∞–ª—è–µ–º active —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
  document.querySelectorAll('.nav button').forEach(btn => {
    btn.classList.remove('active');
  });

  // –°—Ç–∞–≤–∏–º active –ª–∏–±–æ –ø–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–º—É —Å–æ–±—ã—Ç–∏—é, –ª–∏–±–æ –Ω–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –ø–æ data-section
  if (evt && (evt.target || evt.currentTarget)) {
    const btn = evt.currentTarget || evt.target;
    btn.classList.add('active');
  } else {
    const btn = document.querySelector(`.nav button[data-section="${sectionId}"]`);
    if (btn) btn.classList.add('active');
  }

  // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é
  const sec = document.getElementById(sectionId);
  if (sec) sec.classList.add('active');
  currentSection = sectionId;

  // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å–µ–∫—Ü–∏–∏
  if (sectionId === 'patients') {
    renderPatients();
  } else if (sectionId === 'calendar') {
    updateCalendar();
  } else if (sectionId === 'finance') {
    updateFinance();
  }
}

// –†–∞–±–æ—Ç–∞ —Å –ø–∞—Ü–∏–µ–Ω—Ç–∞–º–∏
function addPatient() {
  const fioEl = document.getElementById('fio');
  const phoneEl = document.getElementById('phone');
  const procedureEl = document.getElementById('procedure');
  const doctorSelect = document.getElementById('doctor');
  const dateEl = document.getElementById('date');
  const timeEl = document.getElementById('time');
  const durationEl = document.getElementById('duration');
  const priceEl = document.getElementById('price');
  const paidEl = document.getElementById('paid');
  const notesEl = document.getElementById('notes');

  const doctorId = doctorSelect && doctorSelect.value ? parseInt(doctorSelect.value) : null;
  const doctor = doctors.find(d => d.id === doctorId);

  const dateVal = dateEl ? dateEl.value : '';
  const timeVal = timeEl ? timeEl.value : '';

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏
  const hasConflict = patients.some(p => 
    p.date === dateVal && 
    p.time === timeVal &&
    p.doctorId === doctorId
  );
  
  if (hasConflict) {
    alert('–≠—Ç–æ –≤—Ä–µ–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ —É –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤—Ä–∞—á–∞!');
    return;
  }

  const patient = {
    id: Date.now(),
    fio: fioEl ? fioEl.value.trim() : '',
    phone: phoneEl ? phoneEl.value.trim() : '',
    procedure: procedureEl ? procedureEl.value.trim() : '',
    doctorId: doctorId,
    doctorName: doctor ? doctor.name : '',
    date: dateVal,
    time: timeVal,
    duration: parseInt(durationEl ? durationEl.value : '') || 60,
    price: Number(priceEl ? priceEl.value : '') || 0,
    paid: Number(paidEl ? paidEl.value : '') || 0,
    notes: notesEl ? notesEl.value.trim() : '',
    createdAt: new Date().toISOString()
  };
  
  patients.push(patient);
  localStorage.setItem('patients', JSON.stringify(patients));
  
  // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
  ['fio', 'phone', 'procedure', 'duration', 'price', 'paid', 'notes'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  if (dateEl) dateEl.value = '';
  if (timeEl) timeEl.value = '';
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  alert('–ü–∞—Ü–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã
  renderPatients();
  updateCalendar();
  updateFinance();
}

function renderPatients() {
  const searchTerm = (document.getElementById('search-patient')?.value || '').toLowerCase();
  const filteredPatients = patients.filter(p => 
    (p.fio || '').toLowerCase().includes(searchTerm) ||
    (p.phone || '').includes(searchTerm)
  );
  
  const container = document.getElementById('patient-list');
  if (!container) return;
  
  if (filteredPatients.length === 0) {
    container.innerHTML = '<p style="text-align:center; color:#666;">–ü–∞—Ü–∏–µ–Ω—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
    return;
  }
  
  let html = '';
  filteredPatients.forEach(patient => {
    const debt = patient.price - patient.paid;
    html += `
      <div class="patient">
        <div class="patient-info">
          <div class="patient-name">${patient.fio}</div>
          <div class="patient-meta">üìû ${patient.phone} | üë®‚Äç‚öïÔ∏è ${patient.doctorName || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
          <div class="patient-meta">üìÖ ${patient.date} ${patient.time} | ‚è∞ ${patient.duration} –º–∏–Ω</div>
          <div class="patient-meta">${patient.procedure}</div>
          <div class="patient-payment ${debt > 0 ? 'debt' : 'paid'}">
            üí∞ –û–ø–ª–∞—Ç–∞: ${patient.paid} / ${patient.price} —Å—É–º
            ${debt > 0 ? ` (–î–æ–ª–≥: ${debt})` : ''}
          </div>
          ${patient.notes ? `<div class="patient-meta">üìù ${patient.notes}</div>` : ''}
        </div>
        <div class="patient-actions">
          <button onclick="editPatientPayment(${patient.id})" class="secondary" style="padding:8px 12px;">üí∞</button>
          <button onclick="editPatient(${patient.id})" class="secondary" style="padding:8px 12px;">‚úèÔ∏è</button>
          <button onclick="deletePatient(${patient.id})" class="danger" style="padding:8px 12px;">üóëÔ∏è</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function editPatientPayment(patientId) {
  const patient = patients.find(p => p.id === patientId);
  if (!patient) return;
  
  const newPaid = prompt(`–¢–µ–∫—É—â–∏–π –ø–ª–∞—Ç–µ–∂: ${patient.paid} —Å—É–º\n–û–±—â–∞—è —Å—É–º–º–∞: ${patient.price} —Å—É–º\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—É–º–º—É –æ–ø–ª–∞—Ç—ã:`, patient.paid);
  if (newPaid !== null) {
    const paidAmount = Number(newPaid);
    if (!isNaN(paidAmount)) {
      patient.paid = paidAmount;
      localStorage.setItem('patients', JSON.stringify(patients));
      renderPatients();
      updateFinance();
      alert('–ü–ª–∞—Ç–µ–∂ –æ–±–Ω–æ–≤–ª–µ–Ω!');
    }
  }
}

function editPatient(patientId) {
  selectedPatient = patients.find(p => p.id === patientId);
  if (!selectedPatient) return;
  
  const modal = document.getElementById('patient-modal');
  const content = document.getElementById('modal-patient-content');
  
  content.innerHTML = `
    <div class="form-grid">
      <input id="edit-fio" value="${selectedPatient.fio}" placeholder="–§–ò–û –ø–∞—Ü–∏–µ–Ω—Ç–∞">
      <input id="edit-phone" value="${selectedPatient.phone}" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
      <input id="edit-procedure" value="${selectedPatient.procedure}" placeholder="–ü—Ä–æ—Ü–µ–¥—É—Ä–∞">
      <select id="edit-doctor">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞</option>
        ${doctors.map(d => `<option value="${d.id}" ${d.id === selectedPatient.doctorId ? 'selected' : ''}>${d.name} - ${d.specialty}</option>`).join('')}
      </select>
      <input type="date" id="edit-date" value="${selectedPatient.date}">
      <input type="time" id="edit-time" value="${selectedPatient.time}">
      <input id="edit-duration" value="${selectedPatient.duration}" placeholder="–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)" type="number">
      <input id="edit-price" value="${selectedPatient.price}" placeholder="–ö –æ–ø–ª–∞—Ç–µ (—Å—É–º)" type="number">
      <input id="edit-paid" value="${selectedPatient.paid}" placeholder="–û–ø–ª–∞—á–µ–Ω–æ (—Å—É–º)" type="number">
      <input id="edit-notes" value="${selectedPatient.notes || ''}" placeholder="–ó–∞–º–µ—Ç–∫–∏">
    </div>
    <div style="display:flex; gap:12px; margin-top:20px;">
      <button onclick="savePatientChanges()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button onclick="closeModal()" class="secondary">–û—Ç–º–µ–Ω–∞</button>
    </div>
  `;
  
  modal.style.display = 'flex';
}

function savePatientChanges() {
  if (!selectedPatient) return;
  
  const doctorSelect = document.getElementById('edit-doctor');
  const doctorId = doctorSelect && doctorSelect.value ? parseInt(doctorSelect.value) : null;
  const doctor = doctors.find(d => d.id === doctorId);
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç (–∏—Å–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–µ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞)
  const hasConflict = patients.some(p => 
    p.id !== selectedPatient.id &&
    p.date === document.getElementById('edit-date').value && 
    p.time === document.getElementById('edit-time').value &&
    p.doctorId === doctorId
  );
  
  if (hasConflict) {
    alert('–≠—Ç–æ –≤—Ä–µ–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ —É –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤—Ä–∞—á–∞!');
    return;
  }
  
  selectedPatient.fio = document.getElementById('edit-fio').value.trim();
  selectedPatient.phone = document.getElementById('edit-phone').value.trim();
  selectedPatient.procedure = document.getElementById('edit-procedure').value.trim();
  selectedPatient.doctorId = doctorId;
  selectedPatient.doctorName = doctor ? doctor.name : '';
  selectedPatient.date = document.getElementById('edit-date').value;
  selectedPatient.time = document.getElementById('edit-time').value;
  selectedPatient.duration = parseInt(document.getElementById('edit-duration').value) || 60;
  selectedPatient.price = Number(document.getElementById('edit-price').value) || 0;
  selectedPatient.paid = Number(document.getElementById('edit-paid').value) || 0;
  selectedPatient.notes = document.getElementById('edit-notes').value.trim();
  
  localStorage.setItem('patients', JSON.stringify(patients));
  closeModal();
  renderPatients();
  updateCalendar();
  updateFinance();
  alert('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
}

function deletePatient(patientId) {
  if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞?')) {
    patients = patients.filter(p => p.id !== patientId);
    localStorage.setItem('patients', JSON.stringify(patients));
    renderPatients();
    updateCalendar();
    updateFinance();
  }
}

// –†–∞–±–æ—Ç–∞ —Å –≤—Ä–∞—á–∞–º–∏
function renderDoctorsSelect() {
  const select = document.getElementById('doctor');
  if (!select) return;
  
  select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞</option>' +
    doctors.map(d => `<option value="${d.id}">${d.name} - ${d.specialty}</option>`).join('');
}

function renderDoctors() {
  const container = document.getElementById('doctor-list');
  if (!container) return;
  
  if (doctors.length === 0) {
    container.innerHTML = '<p style="text-align:center; color:#666;">–í—Ä–∞—á–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</p>';
    return;
  }
  
  let html = '';
  doctors.forEach(doctor => {
    const doctorPatients = patients.filter(p => p.doctorId === doctor.id);
    html += `
      <div class="patient">
        <div class="patient-info">
          <div class="patient-name">${doctor.name}</div>
          <div class="patient-meta">${doctor.specialty} | üìû ${doctor.phone}</div>
          <div class="patient-meta">–ü–∞—Ü–∏–µ–Ω—Ç–æ–≤: ${doctorPatients.length}</div>
        </div>
        <div class="patient-actions">
          <button onclick="deleteDoctor(${doctor.id})" class="danger" style="padding:8px 12px;">üóëÔ∏è</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function addDoctor() {
  const name = document.getElementById('doctor-name').value.trim();
  const specialty = document.getElementById('doctor-specialty').value.trim();
  const phone = document.getElementById('doctor-phone').value.trim();
  
  if (!name || !specialty || !phone) {
    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
    return;
  }
  
  const doctor = {
    id: Date.now(),
    name,
    specialty,
    phone
  };
  
  doctors.push(doctor);
  localStorage.setItem('doctors', JSON.stringify(doctors));
  
  // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
  ['doctor-name', 'doctor-specialty', 'doctor-phone'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  
  renderDoctorsSelect();
  renderDoctors();
  alert('–í—Ä–∞—á –¥–æ–±–∞–≤–ª–µ–Ω!');
}

function deleteDoctor(doctorId) {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ –ø–∞—Ü–∏–µ–Ω—Ç—ã —É –≤—Ä–∞—á–∞
  const hasPatients = patients.some(p => p.doctorId === doctorId);
  
  if (hasPatients) {
    alert('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –≤—Ä–∞—á–∞, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –µ—Å—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç—ã!');
    return;
  }
  
  if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –≤—Ä–∞—á–∞?')) {
    doctors = doctors.filter(d => d.id !== doctorId);
    localStorage.setItem('doctors', JSON.stringify(doctors));
    renderDoctorsSelect();
    renderDoctors();
  }
}

// –ö–∞–ª–µ–Ω–¥–∞—Ä—å
function updateCalendar() {
  const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', 
                     '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
  
  const currentMonthEl = document.getElementById('current-month');
  if (currentMonthEl) {
    currentMonthEl.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
  }
  
  const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
  const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
  const daysInMonth = lastDay.getDate();
  const firstDayOfWeek = firstDay.getDay();
  
  let calendarHTML = '';
  
  // –î–Ω–∏ –Ω–µ–¥–µ–ª–∏
  const weekDays = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
  weekDays.forEach(day => {
    calendarHTML += `<div style="text-align:center; padding:8px; color:#666; font-weight:500;">${day}</div>`;
  });
  
  // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –¥–Ω–µ–º
  for (let i = 0; i < (firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1); i++) {
    calendarHTML += `<div class="calendar-day"></div>`;
  }
  
  // –î–Ω–∏ –º–µ—Å—è—Ü–∞
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const dayDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
    const isToday = dayDate.getTime() === today.getTime();
    const hasAppointments = patients.some(p => p.date === dateStr);
    const isSelected = selectedDate === dateStr;
    
    let className = 'calendar-day';
    if (isToday) className += ' today';
    if (hasAppointments) className += ' has-appointments';
    if (isSelected) className += ' selected';
    
    calendarHTML += `
      <div class="${className}" onclick="showDayAppointments('${dateStr}')">
        ${day}
      </div>
    `;
  }
  
  const grid = document.getElementById('calendar-grid');
  if (grid) grid.innerHTML = calendarHTML;
  updateDayAppointments();
}

function prevMonth() {
  currentDate.setMonth(currentDate.getMonth() - 1);
  updateCalendar();
}

function nextMonth() {
  currentDate.setMonth(currentDate.getMonth() + 1);
  updateCalendar();
}

function todayMonth() {
  currentDate = new Date();
  updateCalendar();
}

function showDayAppointments(dateStr) {
  selectedDate = dateStr;
  updateCalendar();
  
  const modal = document.getElementById('day-modal');
  const title = document.getElementById('modal-day-title');
  const content = document.getElementById('modal-day-content');
  
  const dateObj = new Date(dateStr);
  const dayNames = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];
  const monthNames = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è', 
                     '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'];
  
  if (title) title.textContent = `${dateObj.getDate()} ${monthNames[dateObj.getMonth()]} ${dateObj.getFullYear()}, ${dayNames[dateObj.getDay()]}`;
  
  const dayPatients = patients.filter(p => p.date === dateStr);
  
  if (!content) return;
  
  if (dayPatients.length === 0) {
    content.innerHTML = '<p style="text-align:center; color:#666;">–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç</p>';
  } else {
    let html = '<div style="display:flex; flex-direction:column; gap:12px;">';
    
    // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    dayPatients.sort((a, b) => a.time.localeCompare(b.time));
    
    dayPatients.forEach(patient => {
      const debt = patient.price - patient.paid;
      html += `
        <div class="patient">
          <div class="patient-info">
            <div class="patient-name">${patient.fio}</div>
            <div class="patient-meta">‚è∞ ${patient.time} | ${patient.duration} –º–∏–Ω | üë®‚Äç‚öïÔ∏è ${patient.doctorName}</div>
            <div class="patient-meta">${patient.procedure}</div>
            <div class="patient-payment ${debt > 0 ? 'debt' : 'paid'}">
              üí∞ ${patient.paid}/${patient.price} —Å—É–º
            </div>
          </div>
          <div class="patient-actions">
            <button onclick="editPatient(${patient.id})" class="secondary" style="padding:8px 12px;">‚úèÔ∏è</button>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    content.innerHTML = html;
  }
  
  if (modal) modal.style.display = 'flex';
}

function updateDayAppointments() {
  if (!selectedDate) return;
  
  const container = document.getElementById('day-appointments');
  if (!container) return;
  
  const dayPatients = patients.filter(p => p.date === selectedDate);
  
  if (dayPatients.length === 0) {
    container.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç</p>';
    return;
  }
  
  let html = '<h4 style="margin-top:20px;">–ó–∞–ø–∏—Å–∏ –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å:</h4>';
  
  dayPatients.sort((a, b) => a.time.localeCompare(b.time));
  
  dayPatients.forEach(patient => {
    const debt = patient.price - patient.paid;
    html += `
      <div class="patient">
        <div class="patient-info">
          <div class="patient-name">${patient.fio}</div>
          <div class="patient-meta">‚è∞ ${patient.time} | ${patient.duration} –º–∏–Ω | üë®‚Äç‚öïÔ∏è ${patient.doctorName}</div>
          <div class="patient-payment ${debt > 0 ? 'debt' : 'paid'}">
            üí∞ ${patient.paid}/${patient.price} —Å—É–º
          </div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// –§–∏–Ω–∞–Ω—Å—ã
function updateFinance() {
  const totalPrice = patients.reduce((sum, p) => sum + p.price, 0);
  const totalPaid = patients.reduce((sum, p) => sum + p.paid, 0);
  const totalDebt = totalPrice - totalPaid;
  
  // –î–æ—Ö–æ–¥ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
  const now = new Date();
  const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  const monthIncome = patients
    .filter(p => (p.date || '').startsWith(currentMonth))
    .reduce((sum, p) => sum + p.paid, 0);
  
  const totalPriceEl = document.getElementById('total-price');
  const totalPaidEl = document.getElementById('total-paid');
  const totalDebtEl = document.getElementById('total-debt');
  const monthIncomeEl = document.getElementById('month-income');

  if (totalPriceEl) totalPriceEl.textContent = `${totalPrice} —Å—É–º`;
  if (totalPaidEl) totalPaidEl.textContent = `${totalPaid} —Å—É–º`;
  if (totalDebtEl) totalDebtEl.textContent = `${totalDebt} —Å—É–º`;
  if (monthIncomeEl) monthIncomeEl.textContent = `${monthIncome} —Å—É–º`;
  
  // –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
  const paymentHistory = document.getElementById('payment-history');
  if (!paymentHistory) return;
  
  const recentPayments = patients
    .filter(p => p.paid > 0)
    .sort((a, b) => new Date(b.date) - new Date(a.date))
    .slice(0, 10);
  
  if (recentPayments.length === 0) {
    paymentHistory.innerHTML = '<p style="text-align:center; color:#666;">–ü–ª–∞—Ç–µ–∂–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</p>';
    return;
  }
  
  let html = '';
  recentPayments.forEach(p => {
    html += `
      <div class="patient">
        <div class="patient-info">
          <div class="patient-name">${p.fio}</div>
          <div class="patient-meta">üìÖ ${p.date} | ${p.procedure}</div>
          <div class="patient-payment paid">
            üí∞ ${p.paid} —Å—É–º
          </div>
        </div>
      </div>
    `;
  });
  
  paymentHistory.innerHTML = html;
}

// –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
function closeModal() {
  const modal = document.getElementById('patient-modal');
  if (modal) modal.style.display = 'none';
  selectedPatient = null;
}

function closeDayModal() {
  const modal = document.getElementById('day-modal');
  if (modal) modal.style.display = 'none';
}

// –ü–æ–∏—Å–∫ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('search-patient');
  if (searchInput) {
    searchInput.addEventListener('input', renderPatients);
  }
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  const today = new Date().toISOString().split('T')[0];
  const dateEl = document.getElementById('date');
  if (dateEl) dateEl.value = today;

  // edit-date –º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –¥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º
  const editDateEl = document.getElementById('edit-date');
  if (editDateEl) editDateEl.value = today;
  
  init();
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π ESC –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeModal();
    closeDayModal();
  }
});

// –ö–ª–∏–∫ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
window.onclick = function(event) {
  const modals = document.querySelectorAll('.modal');
  modals.forEach(modal => {
    if (event.target === modal) {
      modal.style.display = 'none';
    }
  });
}
</script>
</body>
</html>
